/*typeahead*/
steal("can/control","can/construct/super","can/control/plugin","can/observe","can/event","can/view",function(){can.Typeahead=can.Control.extend({pluginName:"typeahead",defaults:{minLength:3,displayKey:"name",timeout:400,view:void 0,source:void 0,query:{}}},{init:function(){this.suggestions=new can.Map({items:[]}),this.$menu=can.$("<div>").css("position","relative").appendTo(this.element.parent()),can.append(this.$menu,can.view(this.options.view,this.suggestions)),this.$menu.on({mouseenter:can.proxy(this.mouseenter,this),mouseleave:can.proxy(this.mouseleave,this)})},buildQuery:function(e){return can.extend({query:e},this.options.query)},filter:function(e){var t=e.filter(can.proxy(this.validateQuery,this));this.render(t)},ajax:function(e){can.ajax(can.extend(e,{data:this.buildQuery(this.query)})).then(can.proxy(this.render,this))},model:function(e){e(this.buildQuery(this.query)).then(can.proxy(this.render,this))},render:function(e){this.suggestions.attr("items",e),e.forEach(can.proxy(this.setDataAndHighlight,this)),this.$menu.find("a").on({click:can.proxy(this.select,this),onmouseover:can.proxy(this.hover,this)}),this.$active=this.$menu.find("li:first"),this.$active.addClass("active"),this.show()},getItemDisplay:function(e){return can.isPlainObject(e)?e[this.options.displayKey]:e instanceof can.Map?e.attr(this.options.displayKey):e},validateQuery:function(e){return this.getItemDisplay(e).toLowerCase().indexOf(this.query.toLowerCase())>-1},search:function(e){this.query=e,can.isArray(this.options.source)?this.filter(this.options.source):can.isPlainObject(this.options.source)?this.ajax(this.options.source):this.model(this.options.source)},setDataAndHighlight:function(e,t){var i=can.$(this.$menu.find("a")[t]),s=this.getItemDisplay(e).toLowerCase().indexOf(this.query.toLowerCase()),n=this.getItemDisplay(e).substr(0,s),a=this.getItemDisplay(e).substr(s,this.query.length),h=this.getItemDisplay(e).substr(s+this.query.length);i.data("item",e).html(i.html().replace(this.getItemDisplay(e),n+"<strong>"+a+"</strong>"+h))},lookup:function(e){var t=this;this.searchTimer&&clearTimeout(this.searchTimer),can.$(e).val().length>=this.options.minLength?this.searchTimer=setTimeout(function(){t.search(can.$(e).val())},this.options.timeout):1==this.shown&&this.hide()},select:function(e){var t=e?can.$(e.target):this.$menu.find("li.active a");this.element.val(this.getItemDisplay(this.getItemDisplay(t.data("item")))),this.element.data("value",t.data("item")),this.hide(),this.$menu.find("li.active").removeClass("active"),t.parent().addClass("active"),this.element.trigger("can.typeahead.selected")},move:function(e){switch(e){case 38:this.prev();break;case 40:this.next()}},next:function(){this.$active.removeClass("active");var e=this.$active.next();e.length||(e=this.$menu.find("li:first")),e.addClass("active"),this.$active=e,this.element.trigger("can.typeahead.move.next")},prev:function(){this.$active.removeClass("active");var e=this.$active.prev();e.length||(e=this.$menu.find("li:last")),e.addClass("active"),this.$active=e,this.element.trigger("can.typeahead.move.prev")},show:function(){this.element.trigger("can.typeahead.move.show"),this.$menu.find("ul").css("display","block"),this.shown=!0,this.element.trigger("can.typeahead.move.shown")},hide:function(){this.element.trigger("can.typeahead.move.hide"),this.$menu.find("ul").css("display","none"),this.shown=!1,this.element.trigger("can.typeahead.move.hidden")},keyup:function(e,t){switch(t.keyCode){case 40:case 38:if(!this.shown||t.shiftKey)return;t.preventDefault(),t.stopPropagation(),this.move(t.keyCode);break;case 9:case 13:if(!this.shown)return;this.select();break;case 27:if(!this.shown)return;this.hide();break;default:this.lookup(e)}},focus:function(e){this.focused=!0,can.$(e).val().length>=this.options.minLength&&this.show()},blur:function(){this.focused=!1,!this.mouseover&&this.shown&&this.hide()},hover:function(e){this.$menu.find("li.active").removeClass("active"),can.$(e.target).parent().addClass("active")},mouseenter:function(){this.mouseover=!0},mouseleave:function(){this.mouseover=!1,!this.focused&&this.shown&&this.hide()}})});
